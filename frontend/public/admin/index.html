<!DOCTYPE html>
<html>
<head>
    <title>管理者ダッシュボード</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .stat { background: #f0f0f0; padding: 20px; margin: 10px; border-radius: 5px; }
        .error { color: red; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>管理者ダッシュボード</h1>
    <button onclick="loadData()">データを更新</button>

    <div class="stat">
        <h3>統計情報</h3>
        <p>ユーザー数: <span id="user-count">--</span></p>
        <p>ログ数: <span id="log-count">--</span></p>
        <p>評価数: <span id="score-count">--</span></p>
        <p>決定数: <span id="decision-count">--</span></p>
    </div>

    <div id="users-section">
        <h3>ユーザーリスト</h3>
        <div id="users-data">読み込み中...</div>
    </div>

    <div id="logs-section">
        <h3>最新ログ</h3>
        <div id="logs-data">読み込み中...</div>
    </div>
    
    <script>
        const BACKEND_URL = "https://web-production-5fb04.up.railway.app";
        
        async function loadData() {
            console.log("データ読み込み開始...");

            try {
                // 管理者ダッシュボードデータを取得
                try {
                    const dashboardResponse = await fetch(`${BACKEND_URL}/admin/dashboard`, {
                        headers: {
                            'Authorization': 'Basic ' + btoa('admin:climate2025')
                        }
                    });

                    if (dashboardResponse.ok) {
                        const dashboardData = await dashboardResponse.json();
                        console.log("ダッシュボードデータ:", dashboardData);

                        // 統計情報を更新
                        document.getElementById("user-count").textContent = dashboardData.summary?.total_users || 0;
                        document.getElementById("log-count").textContent = dashboardData.summary?.total_logs || 0;
                        document.getElementById("score-count").textContent = dashboardData.summary?.total_simulations || 0;
                        document.getElementById("decision-count").textContent = "N/A";

                        // ユーザーリストを表示
                        if (dashboardData.users && Array.isArray(dashboardData.users)) {
                            let usersHtml = "<ul>";
                            dashboardData.users.forEach(user => {
                                usersHtml += `<li>${user}</li>`;
                            });
                            usersHtml += "</ul>";
                            document.getElementById("users-data").innerHTML = usersHtml;
                        } else {
                            document.getElementById("users-data").innerHTML = "<p>ユーザーデータなし</p>";
                        }

                        // 最新アクティビティを表示
                        if (dashboardData.recent_activity && Array.isArray(dashboardData.recent_activity)) {
                            let logsHtml = "<table><tr><th>ユーザー</th><th>タイプ</th><th>時間</th></tr>";
                            dashboardData.recent_activity.slice(0, 10).forEach(log => {
                                logsHtml += `<tr><td>${log.user_name || 'N/A'}</td><td>${log.type || 'N/A'}</td><td>${log.timestamp || 'N/A'}</td></tr>`;
                            });
                            logsHtml += "</table>";
                            document.getElementById("logs-data").innerHTML = logsHtml;
                        } else {
                            document.getElementById("logs-data").innerHTML = "<p>ログデータなし</p>";
                        }

                    } else {
                        throw new Error(`ダッシュボードAPI エラー: ${dashboardResponse.status}`);
                    }
                } catch (error) {
                    console.error("ダッシュボードデータ読み込み失敗:", error);
                    document.getElementById("user-count").textContent = "0";
                    document.getElementById("users-data").innerHTML = `<div class="error">データ読み込み失敗: ${error.message}</div>`;
                    document.getElementById("logs-data").innerHTML = `<div class="error">データ読み込み失敗: ${error.message}</div>`;
                }

                console.log("データ読み込み完了");

            } catch (error) {
                console.error("全体読み込み失敗:", error);
            }
        }
        
        // 页面加载时自动加载数据
        window.addEventListener("load", loadData);
    </script>
</body>
</html>
